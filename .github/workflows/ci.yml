name: CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      deploy_to_azure:
        description: "Deploy to Azure after successful tests"
        required: false
        default: true
        type: boolean
  schedule:
    - cron: "0 2 * * 0"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  DOTNET_VERSION: 9.0.x
  SOLUTION_PATH: api/Sanzu.sln
  API_PROJECT_PATH: api/src/Sanzu.API/Sanzu.API.csproj
  TEST_PROJECT_PATH: api/tests/Sanzu.Tests/Sanzu.Tests.csproj
  PUBLISH_DIR: api/publish
  BURN_IN_ITERATIONS: "10"

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: |
            api/**/*.csproj
            api/**/packages.lock.json

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Verify formatting
        run: dotnet format ${{ env.SOLUTION_PATH }} --verify-no-changes --severity warn

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: |
            api/**/*.csproj
            api/**/packages.lock.json

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

      - name: Unit tests
        run: >
          dotnet test ${{ env.TEST_PROJECT_PATH }}
          --configuration Release
          --no-build
          --filter "FullyQualifiedName~Unit"
          --logger "trx;LogFileName=unit.trx"
          --results-directory "./artifacts/test-results/unit"

      - name: Integration tests
        run: >
          dotnet test ${{ env.TEST_PROJECT_PATH }}
          --configuration Release
          --no-build
          --filter "FullyQualifiedName~Integration"
          --logger "trx;LogFileName=integration.trx"
          --results-directory "./artifacts/test-results/integration"

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: |
            artifacts/test-results/
          retention-days: 30

  burn-in:
    name: Burn-in Flaky Test Detection
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 60
    if: github.event_name == 'pull_request' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: |
            api/**/*.csproj
            api/**/packages.lock.json

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

      - name: Burn-in loop
        shell: bash
        run: |
          set -euo pipefail
          for i in $(seq 1 "${BURN_IN_ITERATIONS}"); do
            echo "Burn-in iteration ${i}/${BURN_IN_ITERATIONS}"
            dotnet test "${TEST_PROJECT_PATH}" \
              --configuration Release \
              --no-build \
              --filter "FullyQualifiedName~Integration" \
              --logger "trx;LogFileName=burnin-${i}.trx" \
              --results-directory "./artifacts/test-results/burnin"
          done

      - name: Upload burn-in artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: burn-in-failures
          path: |
            artifacts/test-results/
          retention-days: 30

  package:
    name: Package API
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.deploy_to_azure)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: |
            api/**/*.csproj
            api/**/packages.lock.json

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Publish API
        run: >
          dotnet publish ${{ env.API_PROJECT_PATH }}
          --configuration Release
          --no-restore
          --output ${{ env.PUBLISH_DIR }}

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: sanzu-api-package
          path: ${{ env.PUBLISH_DIR }}
          retention-days: 7

  deploy-azure:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest
    needs: package
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.deploy_to_azure)
    environment:
      name: azure-dev
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: sanzu-api-package
          path: ./app-package

      - name: Validate Azure deployment settings
        id: deploy_check
        shell: bash
        run: |
          set -euo pipefail
          missing=0
          invalid=0
          guid_regex='^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$'

          if [ -z "${{ vars.AZURE_WEBAPP_NAME }}" ]; then
            echo "Missing repository variable: AZURE_WEBAPP_NAME"
            missing=1
          fi
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "Missing repository secret: AZURE_CLIENT_ID"
            missing=1
          fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "Missing repository secret: AZURE_TENANT_ID"
            missing=1
          fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "Missing repository secret: AZURE_SUBSCRIPTION_ID"
            missing=1
          fi

          if [ "$missing" -eq 0 ]; then
            if ! [[ "${{ secrets.AZURE_CLIENT_ID }}" =~ $guid_regex ]]; then
              echo "Invalid AZURE_CLIENT_ID format (must be GUID)."
              invalid=1
            fi

            if ! [[ "${{ secrets.AZURE_TENANT_ID }}" =~ $guid_regex ]]; then
              echo "Invalid AZURE_TENANT_ID format (must be GUID)."
              invalid=1
            fi

            if ! [[ "${{ secrets.AZURE_SUBSCRIPTION_ID }}" =~ $guid_regex ]]; then
              echo "Invalid AZURE_SUBSCRIPTION_ID format (must be GUID)."
              invalid=1
            fi

            if [[ "${{ vars.AZURE_WEBAPP_NAME }}" == *"http://"* || "${{ vars.AZURE_WEBAPP_NAME }}" == *"https://"* || "${{ vars.AZURE_WEBAPP_NAME }}" == *".azurewebsites.net"* ]]; then
              echo "Invalid AZURE_WEBAPP_NAME format (use app name only, not URL)."
              invalid=1
            fi
          fi

          echo "Expected federated credential subject: repo:marcopmorais/sanzu:environment:azure-dev"

          if [ "$missing" -eq 1 ] || [ "$invalid" -eq 1 ]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
          else
            echo "ready=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip deploy when Azure settings are missing
        if: steps.deploy_check.outputs.ready != 'true'
        run: echo "Azure deployment skipped until required secrets/variables are configured."

      - name: Azure login
        if: steps.deploy_check.outputs.ready == 'true'
        uses: azure/login@v2
        with:
          auth-type: SERVICE_PRINCIPAL
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy package to Azure Web App
        if: steps.deploy_check.outputs.ready == 'true'
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ vars.AZURE_WEBAPP_NAME }}
          package: ./app-package
