name: CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      deploy_to_azure:
        description: "Deploy full stack to Azure after successful tests"
        required: false
        default: true
        type: boolean
  schedule:
    - cron: "0 2 * * 0"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  DOTNET_VERSION: 9.0.x
  NODE_VERSION: 20.x
  SOLUTION_PATH: api/Sanzu.sln
  API_PROJECT_PATH: api/src/Sanzu.API/Sanzu.API.csproj
  TEST_PROJECT_PATH: api/tests/Sanzu.Tests/Sanzu.Tests.csproj
  FRONTEND_SOURCE_PATH: api/src/Sanzu.Web
  API_PUBLISH_DIR: api/publish
  FRONTEND_PACKAGE_DIR: api/frontend-package
  BURN_IN_ITERATIONS: "10"

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: |
            api/**/*.csproj
            api/**/packages.lock.json

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Verify formatting
        run: dotnet format ${{ env.SOLUTION_PATH }} --verify-no-changes --severity warn

  build-and-test-api:
    name: Build and Test API
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: |
            api/**/*.csproj
            api/**/packages.lock.json

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

      - name: Unit tests
        run: >
          dotnet test ${{ env.TEST_PROJECT_PATH }}
          --configuration Release
          --no-build
          --filter "FullyQualifiedName~Unit"
          --logger "trx;LogFileName=unit.trx"
          --results-directory "./artifacts/test-results/unit"

      - name: Integration tests
        run: >
          dotnet test ${{ env.TEST_PROJECT_PATH }}
          --configuration Release
          --no-build
          --filter "FullyQualifiedName~Integration"
          --logger "trx;LogFileName=integration.trx"
          --results-directory "./artifacts/test-results/integration"

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-failures
          path: artifacts/test-results/
          retention-days: 30

  build-and-test-frontend:
    name: Build and Test Frontend
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_SOURCE_PATH }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.FRONTEND_SOURCE_PATH }}
        run: npm ci

      - name: Unit tests
        working-directory: ${{ env.FRONTEND_SOURCE_PATH }}
        run: npm run test

      - name: Build
        working-directory: ${{ env.FRONTEND_SOURCE_PATH }}
        run: npm run build

  burn-in:
    name: Burn-in Flaky Test Detection
    runs-on: ubuntu-latest
    needs: build-and-test-api
    timeout-minutes: 60
    if: github.event_name == 'pull_request' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: |
            api/**/*.csproj
            api/**/packages.lock.json

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

      - name: Burn-in loop
        shell: bash
        run: |
          set -euo pipefail
          for i in $(seq 1 "${BURN_IN_ITERATIONS}"); do
            echo "Burn-in iteration ${i}/${BURN_IN_ITERATIONS}"
            dotnet test "${TEST_PROJECT_PATH}" \
              --configuration Release \
              --no-build \
              --filter "FullyQualifiedName~Integration" \
              --logger "trx;LogFileName=burnin-${i}.trx" \
              --results-directory "./artifacts/test-results/burnin"
          done

      - name: Upload burn-in artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: burn-in-failures
          path: artifacts/test-results/
          retention-days: 30

  package-api:
    name: Package API
    runs-on: ubuntu-latest
    needs: build-and-test-api
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.deploy_to_azure)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: |
            api/**/*.csproj
            api/**/packages.lock.json

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Publish API
        run: >
          dotnet publish ${{ env.API_PROJECT_PATH }}
          --configuration Release
          --no-restore
          --output ${{ env.API_PUBLISH_DIR }}

      - name: Upload API artifact
        uses: actions/upload-artifact@v4
        with:
          name: sanzu-api-package
          path: ${{ env.API_PUBLISH_DIR }}
          retention-days: 7

  package-frontend:
    name: Package Frontend
    runs-on: ubuntu-latest
    needs: build-and-test-frontend
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.deploy_to_azure)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build clean frontend package
        shell: bash
        run: |
          set -euo pipefail
          rm -rf "${FRONTEND_PACKAGE_DIR}"
          mkdir -p "${FRONTEND_PACKAGE_DIR}"
          rsync -a "${FRONTEND_SOURCE_PATH}/" "${FRONTEND_PACKAGE_DIR}/" \
            --exclude "node_modules" \
            --exclude ".next" \
            --exclude "bin" \
            --exclude "obj" \
            --exclude "test-results" \
            --exclude "tests"
          test -f "${FRONTEND_PACKAGE_DIR}/package.json"

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: sanzu-frontend-package
          path: ${{ env.FRONTEND_PACKAGE_DIR }}
          retention-days: 7

  provision-infra:
    name: Provision Azure Infrastructure
    runs-on: ubuntu-latest
    needs:
      - package-api
      - package-frontend
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.deploy_to_azure)
    permissions:
      id-token: write
      contents: read
    outputs:
      api_webapp_name: ${{ steps.capture.outputs.api_webapp_name }}
      frontend_webapp_name: ${{ steps.capture.outputs.frontend_webapp_name }}
      api_url: ${{ steps.capture.outputs.api_url }}
      frontend_url: ${{ steps.capture.outputs.frontend_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Azure deployment settings
        id: deploy_check
        shell: bash
        run: |
          set -euo pipefail
          missing=0
          invalid=0
          guid_regex='^[0-9a-fA-F-]{36}$'

          if [ -z "${{ vars.AZURE_RESOURCE_GROUP }}" ]; then echo "Missing repository variable: AZURE_RESOURCE_GROUP"; missing=1; fi
          if [ -z "${{ vars.AZURE_LOCATION }}" ]; then echo "Missing repository variable: AZURE_LOCATION"; missing=1; fi
          if [ -z "${{ vars.AZURE_APP_SERVICE_PLAN_NAME }}" ]; then echo "Missing repository variable: AZURE_APP_SERVICE_PLAN_NAME"; missing=1; fi
          if [ -z "${{ vars.AZURE_API_WEBAPP_NAME }}" ]; then echo "Missing repository variable: AZURE_API_WEBAPP_NAME"; missing=1; fi
          if [ -z "${{ vars.AZURE_FRONTEND_WEBAPP_NAME }}" ]; then echo "Missing repository variable: AZURE_FRONTEND_WEBAPP_NAME"; missing=1; fi
          if [ -z "${{ vars.AZURE_SQL_SERVER_NAME }}" ]; then echo "Missing repository variable: AZURE_SQL_SERVER_NAME"; missing=1; fi
          if [ -z "${{ vars.AZURE_SQL_DATABASE_NAME }}" ]; then echo "Missing repository variable: AZURE_SQL_DATABASE_NAME"; missing=1; fi

          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then echo "Missing repository secret: AZURE_CLIENT_ID"; missing=1; fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then echo "Missing repository secret: AZURE_TENANT_ID"; missing=1; fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then echo "Missing repository secret: AZURE_SUBSCRIPTION_ID"; missing=1; fi
          if [ -z "${{ secrets.AZURE_SQL_ADMIN_LOGIN }}" ]; then echo "Missing repository secret: AZURE_SQL_ADMIN_LOGIN"; missing=1; fi
          if [ -z "${{ secrets.AZURE_SQL_ADMIN_PASSWORD }}" ]; then echo "Missing repository secret: AZURE_SQL_ADMIN_PASSWORD"; missing=1; fi

          if [ "$missing" -eq 0 ]; then
            if ! [[ "${{ secrets.AZURE_CLIENT_ID }}" =~ $guid_regex ]]; then echo "Invalid AZURE_CLIENT_ID format."; invalid=1; fi
            if ! [[ "${{ secrets.AZURE_TENANT_ID }}" =~ $guid_regex ]]; then echo "Invalid AZURE_TENANT_ID format."; invalid=1; fi
            if ! [[ "${{ secrets.AZURE_SUBSCRIPTION_ID }}" =~ $guid_regex ]]; then echo "Invalid AZURE_SUBSCRIPTION_ID format."; invalid=1; fi
          fi

          if [ "$missing" -eq 1 ] || [ "$invalid" -eq 1 ]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
          else
            echo "ready=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Fail deploy when Azure settings are missing or invalid
        if: steps.deploy_check.outputs.ready != 'true'
        shell: bash
        run: |
          echo "Azure full-stack deployment blocked. Configure all required variables and secrets."
          exit 1

      - name: Azure login
        if: steps.deploy_check.outputs.ready == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group
        if: steps.deploy_check.outputs.ready == 'true'
        shell: bash
        run: |
          az group create \
            --name "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --location "${{ vars.AZURE_LOCATION }}"

      - name: Deploy infrastructure
        if: steps.deploy_check.outputs.ready == 'true'
        shell: bash
        run: |
          set -euo pipefail
          az deployment group create \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --name "sanzu-stack-${{ github.run_id }}" \
            --template-file "api/infra/azure/main.bicep" \
            --parameters \
              location="${{ vars.AZURE_LOCATION }}" \
              appServicePlanName="${{ vars.AZURE_APP_SERVICE_PLAN_NAME }}" \
              apiWebAppName="${{ vars.AZURE_API_WEBAPP_NAME }}" \
              frontendWebAppName="${{ vars.AZURE_FRONTEND_WEBAPP_NAME }}" \
              sqlServerName="${{ vars.AZURE_SQL_SERVER_NAME }}" \
              sqlDatabaseName="${{ vars.AZURE_SQL_DATABASE_NAME }}" \
              sqlAdminLogin="${{ secrets.AZURE_SQL_ADMIN_LOGIN }}" \
              sqlAdminPassword="${{ secrets.AZURE_SQL_ADMIN_PASSWORD }}"

      - name: Capture deployment outputs
        id: capture
        if: steps.deploy_check.outputs.ready == 'true'
        shell: bash
        run: |
          set -euo pipefail
          outputs_json="$(az deployment group show \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --name "sanzu-stack-${{ github.run_id }}" \
            --query "properties.outputs" -o json)"

          echo "api_webapp_name=$(echo "$outputs_json" | jq -r '.apiWebAppName.value')" >> "$GITHUB_OUTPUT"
          echo "frontend_webapp_name=$(echo "$outputs_json" | jq -r '.frontendWebAppName.value')" >> "$GITHUB_OUTPUT"
          echo "api_url=$(echo "$outputs_json" | jq -r '.apiUrl.value')" >> "$GITHUB_OUTPUT"
          echo "frontend_url=$(echo "$outputs_json" | jq -r '.frontendUrl.value')" >> "$GITHUB_OUTPUT"

  migrate-database:
    name: Apply Database Migrations
    runs-on: ubuntu-latest
    needs:
      - build-and-test-api
      - provision-infra
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.deploy_to_azure)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: |
            api/**/*.csproj
            api/**/packages.lock.json

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Install EF CLI
        shell: bash
        run: dotnet tool install --global dotnet-ef --version 9.0.0

      - name: Run EF migrations
        shell: bash
        working-directory: api
        env:
          ConnectionStrings__DefaultConnection: Server=tcp:${{ vars.AZURE_SQL_SERVER_NAME }}.database.windows.net,1433;Initial Catalog=${{ vars.AZURE_SQL_DATABASE_NAME }};Persist Security Info=False;User ID=${{ secrets.AZURE_SQL_ADMIN_LOGIN }};Password=${{ secrets.AZURE_SQL_ADMIN_PASSWORD }};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;
        run: |
          export PATH="$PATH:/home/runner/.dotnet/tools"
          dotnet ef database update \
            --project src/Sanzu.Infrastructure/Sanzu.Infrastructure.csproj \
            --startup-project src/Sanzu.API/Sanzu.API.csproj \
            --context SanzuDbContext

  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs:
      - package-api
      - provision-infra
      - migrate-database
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.deploy_to_azure)
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download API artifact
        uses: actions/download-artifact@v4
        with:
          name: sanzu-api-package
          path: ./api-package

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy API package to Azure Web App
        id: deploy_api_webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ needs['provision-infra'].outputs.api_webapp_name }}
          package: ./api-package

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs:
      - package-frontend
      - provision-infra
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.deploy_to_azure)
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: sanzu-frontend-package
          path: ./frontend-package

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy frontend package to Azure Web App
        id: deploy_frontend_webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ needs['provision-infra'].outputs.frontend_webapp_name }}
          package: ./frontend-package

  smoke-tests:
    name: Post-deploy Smoke Tests
    runs-on: ubuntu-latest
    needs:
      - deploy-api
      - deploy-frontend
      - provision-infra
    timeout-minutes: 15
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.deploy_to_azure)
    steps:
      - name: Validate API health endpoint
        shell: bash
        run: |
          set -euo pipefail
          api_url="${{ needs['provision-infra'].outputs.api_url }}/health"
          echo "Checking API endpoint: ${api_url}"
          for attempt in {1..10}; do
            status="$(curl -sS -o /dev/null -w "%{http_code}" "${api_url}" || true)"
            if [ "${status}" = "200" ]; then
              echo "API smoke test passed."
              break
            fi
            if [ "${attempt}" = "10" ]; then
              echo "API smoke test failed with HTTP ${status}."
              exit 1
            fi
            sleep 15
          done

      - name: Validate frontend home page
        shell: bash
        run: |
          set -euo pipefail
          frontend_url="${{ needs['provision-infra'].outputs.frontend_url }}/"
          echo "Checking frontend endpoint: ${frontend_url}"
          for attempt in {1..10}; do
            status="$(curl -sS -o /dev/null -w "%{http_code}" "${frontend_url}" || true)"
            if [ "${status}" = "200" ] || [ "${status}" = "301" ] || [ "${status}" = "302" ]; then
              echo "Frontend smoke test passed."
              exit 0
            fi
            echo "Attempt ${attempt}/10 failed with HTTP ${status}. Retrying in 15s..."
            sleep 15
          done
          echo "Frontend smoke test failed."
          exit 1
